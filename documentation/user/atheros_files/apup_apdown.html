<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>APUP and APDOWN &mdash; AP Command 2013.08.15 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootswatch-3.3.4/spacelab/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2013.08.15',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="AP Command 2013.08.15 documentation" href="../../../index.html" />
    <link rel="up" title="Atheros Command Line" href="../atheros_command_line.html" />
    <link rel="next" title="APCFG" href="apcfg.html" />
    <link rel="prev" title="Atheros Command Line" href="../atheros_command_line.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          AP Command</a>
        <span class="navbar-text navbar-version pull-left"><b>2013.08.15</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">User</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">Readme</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">APUP and APDOWN</a><ul>
<li><a class="reference internal" href="#apup">APUP</a></li>
<li><a class="reference internal" href="#apdown">APDOWN</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="../atheros_command_line.html" title="Previous Chapter: Atheros Command Line"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Atheros Comma...</span>
    </a>
  </li>
  <li>
    <a href="apcfg.html" title="Next Chapter: APCFG"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">APCFG &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../../../_sources/documentation/user/atheros_files/apup_apdown.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="apup-and-apdown">
<h1>APUP and APDOWN<a class="headerlink" href="#apup-and-apdown" title="Permalink to this headline">¶</a></h1>
<p>This is an attempt to get the code in here so it is accessible without needing to download it.</p>
<div class="section" id="apup">
<span id="apup-code"></span><h2>APUP<a class="headerlink" href="#apup" title="Permalink to this headline">¶</a></h2>
<p><cite>apup</cite> will bring up the AP using the last saved configuration.</p>
<div class="code bash highlight-python"><div class="highlight"><pre><span></span>cat /etc/ath/apup
#!/bin/sh
##################################################################################
## configure_vlanvap
##
## shell function to configure the vap for vlan
## arguments
##   $1 - $APNAME - name of the interface eg. ath0
##   $2 - $BRNAME - name of the bridge eg. br2
##   $3 - $VLANID - Id of the VLAN, eg 2
##   $4 - $SECMODE - Security mode like WPA
##   $5 - $SECFILE - like 8021x.conf
## call as
##     configure_vlanvap ath0 br2 2 WPA wpa2EAP.conf
##
configure_vlanvap() {
        VAPNAME=$1
        VBRNAME=$2
        VVLANID=$3
        VSECMODE=$4
        VSECFILE=$5
        VIPADDR=$6
        #verify sec args
        if [ &quot;${VSECMODE}&quot; != &quot;None&quot; ]; then
            if [ ${VSECFILE} = &quot;None&quot; ]; then
                echo &quot;No security file specified for $VSECMODE on $VAPNAME&quot;
                exit 1
            fi
        fi
        #add tags on both eth0, eth1 and athx
        VESSID=`iwconfig ${VAPNAME} | grep ESSID | cut -f2 -d\&quot;`
        brctl addbr $VBRNAME
        brctl delif br0 $VAPNAME
        vconfig add $VAPNAME $VVLANID
        vconfig add eth0 $VVLANID
        vconfig add eth1 $VVLANID
        brctl addif $VBRNAME $VAPNAME.$VVLANID
        brctl addif $VBRNAME eth0.$VVLANID
        brctl addif $VBRNAME eth1.$VVLANID
        ifconfig $VAPNAME.$VVLANID up
        ifconfig eth0.$VVLANID up
        ifconfig eth1.$VVLANID up
        ifconfig $VBRNAME $VIPADDR up

        ##
        ## Add a gratutious ARP after the bridge is up to ensure
        ## &quot;Everybody knows your name&quot;
        ##

        if [ &quot;_$VIPADDR&quot; != &quot;_&quot; ]; then
            arping -U -c 1 -I ${VBRNAME} $VIPADDR
        fi

        ##
        ## If hostapd or topology needs to know about this, lets create
        ## a bridge record
        ##

        if [ &quot;${VSECMODE}&quot; != &quot;WEP&quot; -a &quot;${VSECMODE}&quot; != &quot;None&quot; ]; then
            echo -e &quot;\tinterface $VAPNAME&quot; &gt;&gt; /tmp/bc$VVLANID
        fi
}
#end configure_vlanvap

#####################################################################################
##
## &quot;main&quot; procedure
##

MODLIST=`lsmod | cut -f1,0 -d&quot; &quot; | grep ath_hal `

if [ &quot;${MODLIST}&quot; = &quot;ath_hal&quot; ]; then
    echo &quot;AP is already up&quot;
    exit
fi

##
## Bring in the default environmental variables
##

. /etc/ath/apcfg

WAN_IF=${WAN_IF:=eth0}
LAN_IF=${LAN_IF:=eth1}
HOSTAPD_VER=`hostapd -v 2&gt;&amp;1|grep hostapd|cut -f2 -d&#39; &#39;`


if [ &quot;${BEACON_INT}&quot; = &quot;&quot; ]; then
    BEACON_INT=100
fi
##
## For safety, delete all /tmp nodes we may re-create
##

rm -rf /tmp/br*
rm -rf /tmp/bc*
rm -rf /tmp/ap*
rm -rf /tmp/sta*
rm -rf /tmp/top*

##
## Determine the number of radios installed
##

NUMRADIO_AHB=${NUMRADIO_AHB:=0}
NUMRADIO_PCI=`grep -c 168c /proc/bus/pci/devices`
NUMRADIO=`expr ${NUMRADIO_PCI} + ${NUMRADIO_AHB}`

##
## Make sure the number is 1 or 2.  Any other is invalid
##

if [ $NUMRADIO -gt 2 -o $NUMRADIO -lt 1 ]; then
    echo &quot;INVALID CONFIGURATION, RADIO NOT INSTALLED&quot;
    exit 255
fi

if [ &quot;${AP_STARTMODE}&quot; = &quot;dual&quot; ]; then
    if [ $NUMRADIO = 1 ]; then
        AP_STARTMODE=standard
    else
        AP_STARTMODE=multi
    fi
fi

##
## Now, process the modes
##

if [ &quot;${AP_STARTMODE}&quot; = &quot;standard&quot; ]; then
    makeVAP ap &quot;$AP_SSID&quot; $AP_RADIO_ID:$AP_RFPARAM $BEACON_INT
    if [ $? != 0 ]; then
        echo &quot;Unable to create VAP!&quot;
        exit
    fi
    activateVAP ath0:$AP_RADIO_ID br0 $AP_SECMODE $AP_SECFILE $WPS_ENABLE $WPS_VAP_TIE
fi

##
## See the activateVAP script for details on arguments.  Other configuration
## examples are as follows:
##

##
## Root AP for WDS
##

if [ &quot;${AP_STARTMODE}&quot; = &quot;rootap&quot; ]; then
    makeVAP ap-wds &quot;$AP_SSID&quot; $AP_RADIO_ID:$AP_RFPARAM $BEACON_INT
    if [ $? != 0 ]; then
        echo &quot;Unable to create VAP!&quot;
        exit
    fi

    activateVAP ath0:$AP_RADIO_ID br0 $AP_SECMODE $AP_SECFILE
fi
##
## REPEATER
##
## In repeater mode, VAP 1 (ath0) is ALWAYS the AP side, and VAP 2 (ath1) is
## ALWAYS the client side.  Thus, if ROOTAP_MAC needs to be defined, it&#39;s for
## VAP 2 and should be ROOTAP_MAC_2.
##
## If ANY OTHER CONFIGURATION is required, then set AP_STARTMODE=multi and
## set the specific VAP configurations as required.
##

if [ &quot;${AP_STARTMODE}&quot; = &quot;repeater&quot; -o &quot;${AP_STARTMODE}&quot; = &quot;repeater-ind&quot; ]; then
    if [ &quot;${AP_STARTMODE}&quot; = &quot;repeater&quot; ]; then
        APMODE=&quot;ap-wds&quot;
        STAMODE=&quot;sta-wds&quot;
    else
        APMODE=&quot;ap-wds-ind&quot;
        STAMODE=&quot;sta-wds-ind&quot;
    fi
    makeVAP ${APMODE} &quot;$AP_SSID&quot; $AP_RADIO_ID:$AP_RFPARAM $BEACON_INT
    if [ $? != 0 ]; then
        echo &quot;Unable to create VAP!&quot;
        exit
    fi
    makeVAP ${STAMODE} &quot;$AP_SSID_2&quot; $AP_RADIO_ID_2:$AP_RFPARAM_2

    if [ &quot;${ROOTAP_MAC_2}&quot; != &quot;&quot; ]; then
        iwconfig ath1 ap $ROOTAP_MAC_2
    fi
    if [ &quot;${AP_STARTMODE}&quot; = &quot;repeater-ind&quot; ]; then
        activateVAP ath0:$AP_RADIO_ID br0 $AP_SECMODE $AP_SECFILE
        activateVAP ath1:$AP_RADIO_ID_2 br0 $AP_SECMODE_2 $AP_SECFILE_2
    else
        activateVAP ath1:$AP_RADIO_ID_2 br0 $AP_SECMODE_2 $AP_SECFILE_2
        activateVAP ath0:$AP_RADIO_ID br0 $AP_SECMODE $AP_SECFILE
    fi
fi

## Extender AP
##
if [ &quot;${AP_STARTMODE}&quot; = &quot;extap&quot; ]; then
    makeVAP ap &quot;$AP_SSID&quot; $AP_RADIO_ID:$AP_RFPARAM $BEACON_INT
    if [ $? != 0 ]; then
        echo &quot;Unable to create VAP!&quot;
        exit
    fi

    AP_SSID_2=${AP_SSID_2:=$AP_SSID}
    ROOTAP_SSID=${ROOTAP_SSID:=$AP_SSID_2}

    if [ &quot;${ROOTAP_SSID}&quot; = &quot;any&quot; -a  &quot;${ROOTAP_MAC}&quot; = &quot;&quot; ]; then
        echo &quot;ROOTAP_MAC should be set if ROOTAP_SSID=any&quot;
        exit 1
    else
        makeVAP sta-ext &quot;$AP_SSID_2&quot; $AP_RADIO_ID_2:$AP_RFPARAM_2
    fi

    if [ &quot;${ROOTAP_MAC}&quot; != &quot;&quot; ]; then
        iwconfig ath1 ap $ROOTAP_MAC
    fi

    activateVAP ath1:$AP_RADIO_ID_2 br0 $AP_SECMODE_2 $AP_SECFILE_2
    activateVAP ath0:$AP_RADIO_ID br0 $AP_SECMODE $AP_SECFILE
fi

##
## Extender STA
##
if [ &quot;${AP_STARTMODE}&quot; = &quot;extsta&quot; ]; then

    ROOTAP_SSID=${ROOTAP_SSID:=$AP_SSID}

    if [ &quot;${ROOTAP_SSID}&quot; = &quot;any&quot; -a  &quot;${ROOTAP_MAC}&quot; = &quot;&quot; ]; then
        echo &quot;ROOTAP_MAC should be set if ROOTAP_SSID=any&quot;
        exit 1
    else
        makeVAP sta-ext &quot;$ROOTAP_SSID&quot; $AP_RADIO_ID:$AP_RFPARAM
    fi

    if [ &quot;${ROOTAP_MAC}&quot; != &quot;&quot; ]; then
        iwconfig ath0 ap $ROOTAP_MAC
    fi

    activateVAP ath0:$AP_RADIO_ID br0 $AP_SECMODE $AP_SECFILE
fi

##
## &quot;VIRTUAL WIRE&quot; client
##
if [ &quot;${AP_STARTMODE}&quot; = &quot;client&quot; ]; then
    makeVAP sta-wds &quot;$AP_SSID&quot; $AP_RADIO_ID:$AP_RFPARAM
    if [ $? != 0 ]; then
        echo &quot;Unable to create VAP!&quot;
        exit
    fi

    if [ &quot;${ROOTAP_MAC}&quot; != &quot;&quot; ]; then
        iwconfig ath0 ap $ROOTAP_MAC
    fi

    activateVAP ath0:$AP_RADIO_ID br0 $AP_SECMODE $AP_SECFILE
fi


##
## STATION FORWARDING
##
if [ &quot;${AP_STARTMODE}&quot; = &quot;stafwd&quot; ]; then
    makeVAP sta-fwd &quot;$AP_SSID&quot; $AP_RADIO_ID:$AP_RFPARAM
    if [ $? != 0 ]; then
        echo &quot;Unable to create VAP!&quot;
        exit
    fi

    activateVAP ath0:$AP_RADIO_ID br0 $AP_SECMODE $AP_SECFILE
fi

##
## mBSSID case with all types of authentication
## Note that WEP MUST be the first VAP
## This is brute force, but effective.  Note that we set the becon interval
## to 400
##

WEP_INTERFACE=0
if [ &quot;${AP_STARTMODE}&quot; = &quot;multi&quot; ]; then
    NUM_VAP=0
    VAP_COUNT_RADIO_0=0
    VAP_COUNT_RADIO_1=0
    for i in $my_vaps;
    do
        ITER_SSID=&quot;AP_SSID$i&quot;
        ITER_MODE=&quot;AP_MODE$i&quot;
        ITER_SECMODE=&quot;AP_SECMODE$i&quot;
        ITER_RFPARAM=&quot;AP_RFPARAM$i&quot;
        ITER_RADIO_ID=&quot;AP_RADIO_ID$i&quot;
        eval ITER_SSID=\$$ITER_SSID
        eval ITER_MODE=\$$ITER_MODE
        eval ITER_SECMODE=\$$ITER_SECMODE
        eval ITER_RFPARAM=\$$ITER_RFPARAM
        eval ITER_RADIO_ID=\$$ITER_RADIO_ID
        if [ &quot;x${ITER_SSID}&quot; != &quot;x&quot; ]; then
            VAP_COUNT_VAR=&quot;VAP_COUNT_RADIO_$ITER_RADIO_ID&quot;
            eval ITER_VAP_COUNT=\$$VAP_COUNT_VAR
            ITER_VAP_COUNT=$(($ITER_VAP_COUNT+1))
            export $VAP_COUNT_VAR=$ITER_VAP_COUNT
            if [ &quot;$VAP_COUNT_RADIO_0&quot; -gt &quot;$MAX_VAPS_PER_RADIO&quot; -o &quot;$VAP_COUNT_RADIO_1&quot; -gt &quot;$MAX_VAPS_PER_RADIO&quot; ]; then
                echo &quot;Exceeded max VAPs per Radio($MAX_VAPS_PER_RADIO)&quot;
                exit 255
            fi
            if [ &quot;${ITER_SECMODE}&quot; = &quot;WEP&quot; ]; then
                echo $WEP_INTERFACE | grep &quot;R${ITER_RADIO_ID}&quot; &gt; /dev/null
                if [ $? -eq 0 ]; then
                    echo &quot;Unable to create additional WEP VAP&quot;
                    exit 255
                else
                    WEP_INTERFACE=&quot;R${ITER_RADIO_ID}&quot;
                fi
            fi
            BEACON_INTVAL=$(($BEACON_INT * $ITER_VAP_COUNT))
            makeVAP $ITER_MODE &quot;$ITER_SSID&quot; $ITER_RADIO_ID:$ITER_RFPARAM $BEACON_INTVAL
            NUM_VAP=$(($NUM_VAP+1))
            iwconfig | grep -c ath | grep -i $NUM_VAP &gt; /dev/null
            if [ $? != 0 ]; then
                echo &quot;Unable to create VAP!&quot;
                exit
            fi
        fi
    done

    VAP_NUM=0
    for i in $my_vaps;
    do
        ITER_SSID=&quot;AP_SSID$i&quot;
        ITER_RADIO_ID=&quot;AP_RADIO_ID$i&quot;
        ITER_SECMODE=&quot;AP_SECMODE$i&quot;
        ITER_SECFILE=&quot;AP_SECFILE$i&quot;
        ITER_WPS_ENABLE=&quot;WPS_ENABLE$i&quot;
        ITER_WPS_VAP_TIE=&quot;WPS_VAP_TIE$i&quot;
        eval ITER_SSID=\$$ITER_SSID
        eval ITER_RADIO_ID=\$$ITER_RADIO_ID
        eval ITER_SECMODE=\$$ITER_SECMODE
        eval ITER_SECFILE=\$$ITER_SECFILE
        eval ITER_WPS_ENABLE=\$$ITER_WPS_ENABLE
        eval ITER_WPS_VAP_TIE=\$$ITER_WPS_VAP_TIE
        if [ &quot;_${ITER_SSID}&quot; != &quot;_&quot; ]; then
            activateVAP ath$VAP_NUM:$ITER_RADIO_ID br0 $ITER_SECMODE $ITER_SECFILE $ITER_WPS_ENABLE $ITER_WPS_VAP_TIE
            VAP_NUM=$(($VAP_NUM+1))
        fi
    done
fi

if [ &quot;${AP_STARTMODE}&quot; = &quot;multivlan&quot; ]; then
    WEP_INTERFACE=&quot;&quot;
    NUM_VAP=0
    VAP_COUNT_RADIO_0=0
    VAP_COUNT_RADIO_1=0
    for i in $my_vaps;
    do
        ITER_SSID=&quot;AP_SSID$i&quot;
        ITER_MODE=&quot;AP_MODE$i&quot;
        ITER_SECMODE=&quot;AP_SECMODE$i&quot;
        ITER_RFPARAM=&quot;AP_RFPARAM$i&quot;
        ITER_RADIO_ID=&quot;AP_RADIO_ID$i&quot;
        eval ITER_SSID=\$$ITER_SSID
        eval ITER_MODE=\$$ITER_MODE
        eval ITER_SECMODE=\$$ITER_SECMODE
        eval ITER_RFPARAM=\$$ITER_RFPARAM
        eval ITER_RADIO_ID=\$$ITER_RADIO_ID
        if [ &quot;_${ITER_SSID}&quot; != &quot;_&quot; ]; then
            VAP_COUNT_VAR=&quot;VAP_COUNT_RADIO_$ITER_RADIO_ID&quot;
            eval ITER_VAP_COUNT=\$$VAP_COUNT_VAR
            ITER_VAP_COUNT=$(($ITER_VAP_COUNT+1))
            export $VAP_COUNT_VAR=$ITER_VAP_COUNT
            if [ &quot;$VAP_COUNT_RADIO_0&quot; -gt &quot;$MAX_VAPS_PER_RADIO&quot; -o &quot;$VAP_COUNT_RADIO_1&quot; -gt &quot;$MAX_VAPS_PER_RADIO&quot; ]; then
                echo &quot;Exceeded max VAPs per Radio($MAX_VAPS_PER_RADIO)&quot;
                exit 255
            fi
            if [ &quot;${ITER_SECMODE}&quot; = &quot;WEP&quot; ]; then
                echo $WEP_INTERFACE | grep &quot;R${ITER_RADIO_ID}&quot; &gt; /dev/null
                if [ $? -eq 0 ]; then
                    echo &quot;Unable to create additional WEP VAP&quot;
                    exit 255
                else
                    WEP_INTERFACE=&quot;${WEP_INTERFACE}:R${ITER_RADIO_ID}&quot;
                fi
            fi
            BEACON_INTVAL=$(($BEACON_INT * $ITER_VAP_COUNT))
            makeVAP $ITER_MODE &quot;$ITER_SSID&quot; $ITER_RADIO_ID:$ITER_RFPARAM $BEACON_INTVAL
            NUM_VAP=$(($NUM_VAP+1))
            iwconfig | grep -c ath | grep $NUM_VAP &gt; /dev/null
            if [ $? != 0 ]; then
                echo &quot;Unable to create VAP!&quot;
                exit
            fi
        fi
    done

    VAP_NUM=0
    for i in $my_vaps;
    do
        ITER_SSID=&quot;AP_SSID$i&quot;
        ITER_RADIO_ID=&quot;AP_RADIO_ID$i&quot;
        ITER_SECMODE=&quot;AP_SECMODE$i&quot;
        ITER_SECFILE=&quot;AP_SECFILE$i&quot;
        ITER_WPS_ENABLE=&quot;WPS_ENABLE$i&quot;
        ITER_WPS_VAP_TIE=&quot;WPS_VAP_TIE$i&quot;
        ITER_AP_BRNAME=&quot;AP_BRNAME$i&quot;
        eval ITER_SSID=\$$ITER_SSID
        eval ITER_RADIO_ID=\$$ITER_RADIO_ID
        eval ITER_SECMODE=\$$ITER_SECMODE
        eval ITER_SECFILE=\$$ITER_SECFILE
        eval ITER_WPS_ENABLE=\$$ITER_WPS_ENABLE
        eval ITER_WPS_VAP_TIE=\$$ITER_WPS_VAP_TIE
        eval ITER_AP_BRNAME=\$$ITER_AP_BRNAME
        if [ &quot;_${ITER_SSID}&quot; != &quot;_&quot; ]; then
            activateVAP ath$VAP_NUM:$ITER_RADIO_ID $ITER_AP_BRNAME $ITER_SECMODE $ITER_SECFILE $ITER_WPS_ENABLE $ITER_WPS_VAP_TIE
            VAP_NUM=$(($VAP_NUM+1))
        fi
    done

#configure VLANS and bridges
    brctl delif br0 ${WAN_IF}
    brctl delif br0 ${LAN_IF}
    ifconfig br0 0.0.0.0 up
    if [ &quot;${AP_AUTHIF}&quot; = &quot;WAN&quot; ]; then
            ifconfig ${WAN_IF} $AP_IPADDR up
    else
            ifconfig ${LAN_IF} $AP_IPADDR up
    fi

#
#vlan ids must be choosen. This is to provide better control on number of vaps need to be created.
#
    VAP_NUM=0
    for i in $my_vaps;
    do
        ITER_SSID=&quot;AP_SSID$i&quot;
        ITER_VLAN=&quot;AP_VLAN$i&quot;
        ITER_BRNAME=&quot;AP_BRNAME$i&quot;
        ITER_SECMODE=&quot;AP_SECMODE$i&quot;
        ITER_SECFILE=&quot;AP_SECFILE$i&quot;
        ITER_VIPADDR=&quot;AP_VIPADDR$i&quot;
        eval ITER_SSID=\$$ITER_SSID
        eval ITER_VLAN=\$$ITER_VLAN
        eval ITER_BRNAME=\$$ITER_BRNAME
        eval ITER_SECMODE=\$$ITER_SECMODE
        eval ITER_SECFILE=\$$ITER_SECFILE
        eval ITER_VIPADDR=\$$ITER_VIPADDR

        if [ &quot;_${ITER_BRNAME}&quot; = &quot;_&quot; ]; then
            ITER_BRNAME=br${ITER_VLAN}
        fi
        if [ &quot;_${ITER_VLAN}&quot; != &quot;_&quot; ]; then
            configure_vlanvap ath$VAP_NUM ${ITER_BRNAME:=&quot;br2&quot;} ${ITER_VLAN} ${ITER_SECMODE:=&quot;None&quot;} ${ITER_SECFILE:=&quot;None&quot;} ${ITER_VIPADDR}
        fi
        if [ &quot;_${ITER_SSID}&quot; != &quot;_&quot; ]; then
            VAP_NUM=$(($VAP_NUM+1))
        fi
    done
fi

##
## IBSS MODE
##
if [ &quot;${AP_STARTMODE}&quot; = &quot;adhoc&quot; ]; then
    makeVAP adhoc &quot;$IBSS_SSID&quot; $AP_RADIO_ID:$AP_RFPARAM
    if [ $? != 0 ]; then
        echo &quot;Unable to create VAP!&quot;
        exit
    fi

    activateVAP ath0:$AP_RADIO_ID br0 $AP_SECMODE $AP_SECFILE
fi

##############

echo &quot;CHH: System Configuration&quot;
cfg -s

##############

IS_WPA=`set | grep WPA`
IS_WPS=`set | grep &quot;WPS_ENABLE&quot; | grep 1`

##
## Now, make the topology file
##

if [ &quot;${IS_WPA}&quot; != &quot;&quot; -o &quot;${IS_WPS}&quot; != &quot;&quot; ]; then
    if [ &quot;${HOSTAPD_VER}&quot; != &quot;v0.5.9&quot; ]; then
        if [ -f /tmp/conf_filename ]; then
            hostapd  -B `cat /tmp/conf_filename`
        fi
        if [ -f /tmp/sta_conf_filename ]; then
            wpa_supplicant  -B `cat /tmp/sta_conf_filename`
        fi

    else
        echo &quot;Making Topology File . . .&quot;
        # for vlan case we should not be adding br0
        if [ -f /tmp/br0 ] &amp;&amp; [ &quot;${AP_STARTMODE}&quot; != &quot;multivlan&quot; ]; then
            echo -e &quot;bridge br0&quot; &gt; /tmp/topology.conf
            echo -e &quot;{&quot; &gt;&gt; /tmp/topology.conf
            echo -e &quot;\tipaddress ${AP_IPADDR}&quot; &gt;&gt; /tmp/topology.conf
            echo -e &quot;\tipmask ${AP_NETMASK}&quot; &gt;&gt; /tmp/topology.conf
            cat /tmp/br0 &gt;&gt; /tmp/topology.conf
            echo -e &quot;\tinterface eth0&quot; &gt;&gt; /tmp/topology.conf
            echo -e &quot;\tinterface eth1&quot; &gt;&gt; /tmp/topology.conf
            echo -e &quot;}&quot; &gt;&gt; /tmp/topology.conf
        else
            echo &quot;bridge none&quot; &gt; /tmp/topology.conf
            echo &quot;{&quot; &gt;&gt; /tmp/topology.conf
            echo &quot;}&quot; &gt;&gt; /tmp/topology.conf
        fi

    ##
    ## Assume up to 8 vlan specifications
    ##
    for i in $my_vaps;
    do
        ITER_VLAN=&quot;AP_VLAN$i&quot;
        ITER_BRNAME=&quot;AP_BRNAME$i&quot;
        eval ITER_VLAN=\$$ITER_VLAN
        eval ITER_BRNAME=\$$ITER_BRNAME
        if [ -f /tmp/bc${ITER_VLAN} ]; then
            echo -e &quot;bridge ${ITER_BRNAME}&quot; &gt;&gt; /tmp/topology.conf
            echo -e &quot;{&quot; &gt;&gt; /tmp/topology.conf
            echo -e &quot;\tinterface eth0.${ITER_VLAN}&quot; &gt;&gt; /tmp/topology.conf
            echo -e &quot;\tinterface eth1.${ITER_VLAN}&quot; &gt;&gt; /tmp/topology.conf
            cat /tmp/bc${ITER_VLAN} &gt;&gt; /tmp/topology.conf
            echo -e &quot;}&quot; &gt;&gt; /tmp/topology.conf
            #when the file is processed rename it with .done, so that we
            #do not process it again. This should help when we have same
            #vlan for all the vaps in mbssid
            mv /tmp/bc${ITER_VLAN} /tmp/bc${ITER_VLAN}.done
        fi
    done

    if [ -f /tmp/aplist0 -o -f /tmp/stalist0 ]; then
        echo &quot;radio wifi0&quot; &gt;&gt; /tmp/topology.conf
        echo &quot;{&quot; &gt;&gt; /tmp/topology.conf

        if [ -f /tmp/aplist0 ]; then
            echo -e &quot;\tap&quot; &gt;&gt; /tmp/topology.conf
            echo -e &quot;\t{&quot; &gt;&gt; /tmp/topology.conf
            cat /tmp/aplist0 &gt;&gt; /tmp/topology.conf
            echo -e &quot;\t}&quot; &gt;&gt; /tmp/topology.conf
        fi

        if [ -f /tmp/stalist0 ]; then
            cat /tmp/stalist0 &gt;&gt; /tmp/topology.conf
        fi

        echo &quot;}&quot; &gt;&gt; /tmp/topology.conf
    fi

    if [ -f /tmp/aplist1 -o -f /tmp/stalist1 ]; then
        echo &quot;radio wifi1&quot; &gt;&gt; /tmp/topology.conf
        echo &quot;{&quot; &gt;&gt; /tmp/topology.conf

        if [ -f /tmp/aplist1 ]; then
            echo -e &quot;\tap&quot; &gt;&gt; /tmp/topology.conf
            echo -e &quot;\t{&quot; &gt;&gt; /tmp/topology.conf
            cat /tmp/aplist1 &gt;&gt; /tmp/topology.conf
            echo -e &quot;\t}&quot; &gt;&gt; /tmp/topology.conf
        fi

        if [ -f /tmp/stalist1 ]; then
            cat /tmp/stalist1 &gt;&gt; /tmp/topology.conf
        fi
        echo &quot;}&quot; &gt;&gt; /tmp/topology.conf
    fi

    #
    # Start hostapd &amp; wsc_supplicant.  Check for the
    # appropriate file lists to determine if they need
    # to be started . . .
    #
    # Note that /var/run is statically linked to /tmp . . .
    #

    if [ -f /tmp/aplist0 -o -f /tmp/aplist1 ]; then
        hostapd /var/run/topology.conf &amp;
    fi
    if [ -f /tmp/stalist0 -o -f /tmp/stalist1 ]; then
        sleep 2
        wpa_supplicant /var/run/topology.conf &amp;
    fi
  fi
fi

#check if VoW need to be enabled
if [ &quot;${VOW_ENABLE}&quot; -eq &quot;1&quot; ]; then
    iwpriv wifi0 setVowExt 31
fi

if [ &quot;${VOW_ENABLE_2}&quot; -eq &quot;1&quot; ]; then
    iwpriv wifi1 setVowExt 31
fi
~ #
</pre></div>
</div>
</div>
<div class="section" id="apdown">
<span id="apdown-code"></span><h2>APDOWN<a class="headerlink" href="#apdown" title="Permalink to this headline">¶</a></h2>
<p><cite>apdown</cite> will take down the AP (all the VAPs will be destroyed).</p>
<div class="code bash highlight-python"><div class="highlight"><pre><span></span>cat /etc/ath/apdown
#!/bin/sh
##
## Compatability scripts for older versions
##

WPS_LED_OFF=1
echo $WPS_LED_OFF  &gt; /proc/simple_config/simple_config_led

KER_VER_31=`set | uname -a | grep -c &quot;2.6.31&quot;`
if [ &quot;${KER_VER_31}&quot; = 1 ]; then
    pktlogconf -d
fi


killVAP all
#Finally, unload all modules
sleep 3
/etc/rc.d/rc.wlan down
rm -f /tmp/.apup
~ #
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2013, russelln.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.<br/>
    </p>
  </div>
</footer>
  </body>
</html>